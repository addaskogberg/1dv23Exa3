<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Page Title</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" type="text/css" media="screen" href="issues.css" />
  <script src='/socket.io/socket.io.js'></script>
</head>
<body>
  <h1>1dv023 Exam 3 - Issue List</h1>

  <div id="issues">
    <h1 id="header">Issue</h1>
  </div>

  <div id="comments">
    <h1 id="header">Issue comment</h1>
  </div>
  
  <script>
    getText = function(url, callback) // How can I use this callback?
    {
        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function()
        {
            if (xhr.readyState == 4 && xhr.status == 200)
            {
                callback(xhr.responseText); // Another callback here
            }
        }; 
        xhr.open('GET', url, true)
        xhr.setRequestHeader('Authorization', 'token 91486f6fcb2a852e0ef3b08bbdbb1161396c731a')
        xhr.send()
    }

    function mycallback(data) {
      var githubdata = JSON.parse(data)
      for(let i=0; i < githubdata.length; i++){
        var paragraph = githubdata[i].title
        + ' saying ' + githubdata[i].body
        + ' posted by ' + githubdata[i].user.login 
        + ' at ' + githubdata[i].created_at
        var text = document.createTextNode(paragraph)
        var p = document.createElement('p')
        var img = document.createElement('img')
        img.setAttribute('src', githubdata[i].user.avatar_url)
        var div = document.createElement('div')
        div.setAttribute('class', 'issue')

        var issue = document.getElementById('issues')
        p.appendChild(text)
        div.appendChild(img)
        div.appendChild(p)
        issue.appendChild(div)
      }
    }
    getText('https://api.github.com/repos/1dv023/as224wq-examination-3/issues', mycallback); //passing mycallback as a method



    // Working code
    var socket = io()

    socket.on('issue', function (data) {
      addIssue(data)
    })
    socket.on('issue_comment', function (data) {
      addIssueComment(data)
    })

    function addIssue (message) {
      console.log(message.issue)
      var paragraph = message.issue.title
        + ' saying ' + message.issue.body
        + ' posted by ' + message.issue.user.login 
        + ' at ' + message.issue.created_at
      var text = document.createTextNode(paragraph)
      var p = document.createElement('p')
      var img = document.createElement('img')
      img.setAttribute('src', message.issue.user.avatar_url)
      var div = document.createElement('div')
      div.setAttribute('class', 'issue')

      var issue = document.getElementById('issues')
      p.appendChild(text)
      div.appendChild(img)
      div.appendChild(p)
      issue.appendChild(div)
    }

    function addIssueComment (message) {
      console.log(message.issue_comment)
      var paragraph = message.issue_comment.body 
        + ' posted by ' + message.issue_comment.user.login
        + ' at ' + message.issue_comment.created_at
        + ' is a comment on '
      
      var text = document.createTextNode(paragraph)
      var p = document.createElement('p')
      var a = document.createElement('a')
      a.setAttribute('href', message.issue_comment.html_url)
      var link = document.createTextNode('this issue')

      var comments = document.getElementById('comments')
      a.appendChild(link)
      p.appendChild(text)
      p.appendChild(a)      
      comments.appendChild(p)
    }

  </script>
  
</body>
</html>